import Vue from 'vue';
import VueApollo from 'vue-apollo';
import VulnerabilityTraining, {
  i18n,
} from 'ee/vulnerabilities/components/vulnerability_training.vue';
import { shallowMountExtended } from 'helpers/vue_test_utils_helper';
import { SUPPORTED_REFERENCE_SCHEMA } from 'ee/vulnerabilities/constants';
import createMockApollo from 'helpers/mock_apollo_helper';
import waitForPromises from 'helpers/wait_for_promises';
import { createMockResolvers } from 'jest/security_configuration/mock_data';

const defaultProps = {
  identifiers: [{ externalType: SUPPORTED_REFERENCE_SCHEMA.cwe }, { externalType: 'cve' }],
};

Vue.use(VueApollo);

describe('VulnerabilityTraining component', () => {
  let wrapper;
  let apolloProvider;

  const createApolloProvider = ({ resolvers } = {}) => {
    apolloProvider = createMockApollo([], createMockResolvers({ resolvers }));
  };

  const createComponent = (props = {}, { secureVulnerabilityTraining = true } = {}) => {
    wrapper = shallowMountExtended(VulnerabilityTraining, {
      propsData: {
        ...defaultProps,
        ...props,
      },
      apolloProvider,
      provide: {
        glFeatures: {
          secureVulnerabilityTraining,
        },
      },
    });
  };

  beforeEach(async () => {
    createApolloProvider();
  });

  afterEach(() => {
    wrapper.destroy();
    apolloProvider = null;
  });

  const waitForQueryToBeLoaded = () => waitForPromises();
  const findTitle = () => wrapper.findByRole('heading', i18n.trainingTitle);
  const findDescription = () => wrapper.findByTestId('description');
  const findUnavailableMessage = () => wrapper.findByTestId('unavailable-message');

  describe('basic structure', () => {
    beforeEach(() => {
      createComponent();
    });

    it('displays the title', async () => {
      await waitForQueryToBeLoaded();
      expect(findTitle().text()).toBe(i18n.trainingTitle);
    });

    it('displays the description', async () => {
      await waitForQueryToBeLoaded();
      expect(findDescription().text()).toBe(i18n.trainingDescription);
    });

    it('does not render component when there are no identifiers', () => {
      createComponent({ identifiers: [] });
      expect(wrapper.html()).toBeFalsy();
    });

    it('does not render component when there are no securityTrainingProviders', () => {
      expect(wrapper.html()).toBeFalsy();
    });
  });

  describe('training availability message', () => {
    it('displays the message', async () => {
      createComponent({
        identifiers: [{ externalType: 'not supported identifier' }],
      });
      await waitForQueryToBeLoaded();
      expect(findUnavailableMessage().text()).toBe(i18n.trainingUnavailable);
    });

    it.each`
      identifier                                      | exists
      ${'not supported identifier'}                   | ${true}
      ${SUPPORTED_REFERENCE_SCHEMA.cwe.toUpperCase()} | ${false}
      ${SUPPORTED_REFERENCE_SCHEMA.cwe.toLowerCase()} | ${false}
    `('sets it to "$exists" for "$identifier"', async ({ identifier, exists }) => {
      createComponent({ identifiers: [{ externalType: identifier }] });
      await waitForQueryToBeLoaded();
      expect(findUnavailableMessage().exists()).toBe(exists);
    });
  });

  describe('when secureVulnerabilityTraining feature flag is disabled', () => {
    it('does not render the VulnerabilityTraining component', () => {
      createComponent({}, { secureVulnerabilityTraining: false });
      expect(wrapper.html()).toBeFalsy();
    });
  });
});
